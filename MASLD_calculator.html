<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>生理運動消耗與 MASLD(+) 線上計算機 </title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    .row { margin-bottom: 14px; }
    label { display: inline-block; width: 120px; }
    select, input { width: 100px; }
    #result { font-size: 1.2em; margin-top: 24px; font-weight: bold; color: #005580; }
    .note { font-size: 0.85em; color: #888; }
    #advice { margin-top: 16px; font-size: 1em;}
    .advice-block { margin-bottom: 10px;}
    .diff { color: green; font-weight:bold; }
  </style>
</head>
<body>
  <h2>Nomogram MASLD(+) 預測線上計算機 By苡驊哥哥</h2>
  <form id="nomogramForm" onsubmit="return false;">
    <div class="row">
      <label for="PAEE">運動消耗 PAEE(kcal/week)</label>
      <input type="number" id="PAEE" min="0" max="9000" step="any" value="0">
    </div>
    <div class="row">
      <label for="workstreng">您的工作強度</label>
      <select id="workstreng">
        <option value="1">大部分時間坐著</option>
        <option value="2">頻繁重複坐下,走動</option>
        <option value="3">大部分站立,走動</option>
        <option value="4">需用全身肌肉</option>
      </select>
    </div>
    <div class="row">
      <label for="age">您的年齡</label>
      <input type="number" id="age" min="15" max="65" step="any" value="20">
    </div>
    <div class="row">
      <label for="gender">您的性別</label>
      <select id="gender">
        <option value="Female">Female</option>
        <option value="Male">Male</option>
      </select>
    </div>
    <div class="row">
      <label for="g_bmi">您的BMI數值</label>
      <input type="number" id="g_bmi" min="10" max="55" step="any" value="25">
    </div>
    <div class="row">
      <label for="Smoking">您是否抽過菸?</label>
      <select id="Smoking">
        <option value="0">從未抽過</option>
        <option value="1">有抽過/曾經抽過</option>
      </select>
    </div>
    <div class="row">
      <label for="Alcohol">您是否喝酒?</label>
      <select id="Alcohol">
        <option value="0">從未喝過</option>
        <option value="1">有喝過/曾經喝過</option>
      </select>
    </div>
    <div class="row">
      <label for="DM">您是否有糖尿病?</label>
      <select id="DM">
        <option value="0">無</option>
        <option value="1">有,第一型糖尿病</option>
        <option value="2">有,第二型糖尿病</option>
      </select>
    </div>
    <div class="row">
      <label for="HLP">您是否有高血脂症?</label>
      <select id="HLP">
        <option value="0">否</option>
        <option value="1">是</option>
      </select>
    </div>
    <div class="row">
      <label for="HTN">您是否有高血壓?</label>
      <select id="HTN">
        <option value="0">否</option>
        <option value="1">是</option>
      </select>
    </div>
    <div class="row">
      <label for="CKD">您是否有慢性腎臟疾病?</label>
      <select id="CKD">
        <option value="0">否</option>
        <option value="1">是</option>
      </select>
    </div>
    <button type="button" onclick="calculate()">計算</button>
  </form>
  <div id="result"></div>
  <div id="advice"></div>
  <div class="note">
    <p>請依照您的狀況輸入 能量消耗PAEE、年齡、BMI，其餘變數選擇對應值，即可預測 MASLD 機率。</p>
    <p>此預測工具僅供學術參考，並非臨床診斷依據。</p>
  </div>
  <script>
    // 連續變數的分數對照表
    const PAEE_points = [
      {value:0, points:9},{value:1000, points:8},{value:2000, points:7},
      {value:3000, points:6},{value:4000, points:5},{value:5000, points:4},
      {value:6000, points:3},{value:7000, points:2},{value:8000, points:1},{value:9000, points:0}
    ];
    const age_points = [
      {value:15, points:0},{value:20, points:1},{value:25, points:1},
      {value:30, points:2},{value:35, points:2},{value:40, points:3},
      {value:45, points:3},{value:50, points:4},{value:55, points:4},
      {value:60, points:5},{value:65, points:6}
    ];
    const g_bmi_points = [
      {value:10, points:0},{value:15, points:11},{value:20, points:22},
      {value:25, points:33},{value:30, points:44},{value:35, points:56},
      {value:40, points:67},{value:45, points:78},{value:50, points:89},{value:55, points:100}
    ];

    // 類別變數分數表
    const scoreTable = {
      workstreng: { "1": 7, "2": 4, "3": 2, "4": 0 },
      gender: { "Female": 0, "Male": 6 },
      Smoking: { "0": 0, "1": 0 },
      Alcohol: { "0": 1, "1": 0 },
      DM: { "0": 0, "1": 4, "2": 6 },
      HLP: { "0": 0, "1": 2 },
      HTN: { "0": 0, "1": 0 },
      CKD: { "0": 2, "1": 0 }
    };

    // 總分與預測機率對照表
    const totalPointsToProb = [
      { points: 45, prob: 0.01 },
      { points: 53, prob: 0.05 },
      { points: 57, prob: 0.10 },
      { points: 61, prob: 0.20 },
      { points: 67, prob: 0.50 },
      { points: 74, prob: 0.80 },
      { points: 82, prob: 0.95 },
      { points: 90, prob: 0.99 }
    ];

    // 線性內插 function
    function interpolate(x, table, xkey="value", ykey="points") {
      if (x <= table[0][xkey]) return table[0][ykey];
      if (x >= table[table.length-1][xkey]) return table[table.length-1][ykey];
      for (let i = 0; i < table.length - 1; i++) {
        let a = table[i], b = table[i+1];
        if (x >= a[xkey] && x <= b[xkey]) {
          return a[ykey] + (b[ykey] - a[ykey]) * (x - a[xkey]) / (b[xkey] - a[xkey]);
        }
      }
      return null;
    }

    function getTotal(paee, age, bmi, fields) {
      let total = 0;
      total += interpolate(paee, PAEE_points, "value", "points");
      total += interpolate(age, age_points, "value", "points");
      total += interpolate(bmi, g_bmi_points, "value", "points");
      for (let field in scoreTable) {
        let val = fields && fields[field] !== undefined ? fields[field] : document.getElementById(field).value;
        total += Number(scoreTable[field][val]);
      }
      return total;
    }

    function getProb(total) {
      return interpolate(total, totalPointsToProb, "points", "prob");
    }

    function calculate() {
      let paee = parseFloat(document.getElementById('PAEE').value) || 0;
      let age = parseFloat(document.getElementById('age').value) || 0;
      let bmi = parseFloat(document.getElementById('g_bmi').value) || 0;

      // 目前各分類變數的值組成物件
      let fields = {};
      for (let field in scoreTable) {
        fields[field] = document.getElementById(field).value;
      }

      // 目前
      let totalNow = getTotal(paee, age, bmi, fields);
      let probNow = getProb(totalNow);

      // PAEE+1000 (上限不超過9000)
      let paeePlus = Math.min(paee+1000, 9000);
      let totalPAEEup = getTotal(paeePlus, age, bmi, fields);
      let probPAEEup = getProb(totalPAEEup);

      // BMI-5 (下限不小於10)
      let bmiMinus = Math.max(bmi-5, 10);
      let totalBMImin = getTotal(paee, age, bmiMinus, fields);
      let probBMImin = getProb(totalBMImin);

      // 差異
      let paeeDiff = probNow - probPAEEup;
      let bmiDiff = probNow - probBMImin;

      // 輸出
      document.getElementById('result').innerHTML =
        `總分: <b>${totalNow.toFixed(2)}</b>，預測 MASLD(+) 機率: <b>${(probNow*100).toFixed(1)}%</b>`;

      document.getElementById('advice').innerHTML =
        `<div class="advice-block">
          每週增加 <b>1000</b> 能量消耗，可降低約 <b>${paeeDiff > 0 ? (paeeDiff*100).toFixed(1): "0.0"}%</b> MASLD風險
        </div>
        <div class="advice-block">
          降低 <b>5</b> BMI，可降低約 <b>${bmiDiff > 0 ? (bmiDiff*100).toFixed(1): "0.0"}%</b> MASLD風險
        </div>`;
    }
  </script>
</body>
</html>
